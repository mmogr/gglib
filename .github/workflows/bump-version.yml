name: Bump Version

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'New version (semver format: X.Y.Z or X.Y.Z-alpha.N)'
        required: true
        type: string
      auto_merge:
        description: 'Enable auto-merge on the PR (requires branch protection)'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  validate-and-bump:
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for tag checks

      - name: Fetch tags
        run: git fetch --force --tags

      - name: Validate semver format
        id: validate
        run: |
          VERSION="${{ inputs.version }}"
          
          # Semver regex (supports prerelease like alpha.1, beta.2)
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+(\.[0-9]+)?)?$'; then
            echo "::error::Invalid semver format: $VERSION"
            echo "Expected format: X.Y.Z or X.Y.Z-alpha.N"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ“ Valid semver format: $VERSION"

      - name: Get current version
        id: current
        run: |
          CURRENT=$(grep '^version = ' Cargo.toml | head -n1 | sed -E 's/version = "(.*)"/\1/')
          echo "version=$CURRENT" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT"

      - name: Check if version already exists
        run: |
          NEW_VERSION="${{ steps.validate.outputs.version }}"
          CURRENT_VERSION="${{ steps.current.outputs.version }}"
          
          # Check if tag exists
          if git tag -l | grep -q "^v${NEW_VERSION}$"; then
            echo "::error::Version v$NEW_VERSION already tagged"
            exit 1
          fi
          
          # Check if version is the same (no-op)
          if [ "$NEW_VERSION" = "$CURRENT_VERSION" ]; then
            echo "::error::Version $NEW_VERSION is already current"
            exit 1
          fi
          
          echo "âœ“ Version $NEW_VERSION is new"

      - name: Check version monotonicity (basic)
        run: |
          NEW="${{ steps.validate.outputs.version }}"
          CURRENT="${{ steps.current.outputs.version }}"
          
          # Extract major.minor.patch (ignore prerelease for basic check)
          NEW_BASE=$(echo "$NEW" | sed -E 's/([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          CURRENT_BASE=$(echo "$CURRENT" | sed -E 's/([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          
          # Simple lexicographic comparison (good enough for most cases)
          if [ "$NEW_BASE" = "$CURRENT_BASE" ]; then
            echo "::warning::Same base version - ensure prerelease progression is intentional"
          fi
          
          echo "Version progression: $CURRENT â†’ $NEW"

      - name: Update version in Cargo.toml
        run: |
          VERSION="${{ steps.validate.outputs.version }}"
          sed -i 's/^version = ".*"/version = "'$VERSION'"/' Cargo.toml
          
          # Verify the change
          NEW_VERSION=$(grep '^version = ' Cargo.toml | head -n1 | sed -E 's/version = "(.*)"/\1/')
          if [ "$NEW_VERSION" != "$VERSION" ]; then
            echo "::error::Failed to update Cargo.toml"
            exit 1
          fi
          
          echo "âœ“ Updated Cargo.toml to $VERSION"

      - name: Sync versions to other files
        run: |
          python3 scripts/sync_versions.py
          echo "âœ“ Synced versions across project"

      - name: Update lockfiles
        run: |
          cargo generate-lockfile
          cargo generate-lockfile --manifest-path src-tauri/Cargo.toml

      - name: Verify lockfiles (no build)
        run: |
          cargo metadata --locked --format-version 1 > /dev/null
          cargo metadata --locked --format-version 1 --manifest-path src-tauri/Cargo.toml > /dev/null

      - name: Stage lockfiles
        run: |
          git add Cargo.lock
          if [ -f src-tauri/Cargo.lock ]; then git add src-tauri/Cargo.lock; fi

      - name: Verify changes
        run: |
          VERSION="${{ steps.validate.outputs.version }}"
          
          # Check that key files were updated
          for file in package.json src-tauri/tauri.conf.json; do
            if ! grep -q "\"version\": \"$VERSION\"" "$file"; then
              echo "::error::$file was not updated correctly"
              exit 1
            fi
            echo "âœ“ Verified $file"
          done

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          # Using GitHub App token to ensure PR triggers CI workflows
          token: ${{ steps.app-token.outputs.token }}
          branch: bump-v${{ steps.validate.outputs.version }}
          branch-suffix: timestamp
          delete-branch: true
          title: "Bump version to ${{ steps.validate.outputs.version }}"
          commit-message: "Bump version to ${{ steps.validate.outputs.version }}"
          body: |
            ## Version Bump
            
            Automated version bump from `${{ steps.current.outputs.version }}` â†’ `${{ steps.validate.outputs.version }}`
            
            ### Files Updated
            - âœ“ `Cargo.toml` (workspace)
            - âœ“ `Cargo.lock` (workspace)
            - âœ“ `package.json`
            - âœ“ `src-tauri/Cargo.toml`
            - âœ“ `src-tauri/Cargo.lock`
            - âœ“ `src-tauri/tauri.conf.json`
            - âœ“ All workspace crates (via inheritance)
            
            ### Next Steps
            Once this PR is merged, the [Release workflow](.github/workflows/release.yml) will automatically:
            1. Create git tag `v${{ steps.validate.outputs.version }}`
            2. Generate GitHub release
            3. Deploy documentation
            
            ---
            *Triggered by @${{ github.actor }}*
          labels: |
            version-bump
            automated
          draft: false

      - name: Enable auto-merge
        if: steps.create-pr.outputs.pull-request-number && inputs.auto_merge == true
        run: |
          gh pr merge ${{ steps.create-pr.outputs.pull-request-number }} --auto --squash
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Summary
        if: steps.create-pr.outputs.pull-request-number
        run: |
          echo "### âœ“ Version Bump PR Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** ${{ steps.create-pr.outputs.pull-request-url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.current.outputs.version }} â†’ ${{ steps.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.auto_merge }}" = "true" ]; then
            echo "ðŸ¤– Auto-merge enabled - PR will merge automatically once checks pass" >> $GITHUB_STEP_SUMMARY
          else
            echo "â¸ï¸  Manual merge required" >> $GITHUB_STEP_SUMMARY
          fi
